<!-- templates/admin.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
    label { display: inline-block; width: 150px; }
    input { margin: 5px; padding: 5px; }
    button { padding: 8px 15px; margin: 5px; }
    .message { padding: 10px; margin: 10px 0; }
    .success { background: #d4ffd4; }
    .error { background: #ffd4d4; }
    .user-item { padding: 8px; margin: 3px 0; background: #f5f5f5; }
    .admin-user { background: #fff3cd; }
  </style>
</head>
<body>
  <h2>Admin Dashboard</h2>
  <p id="who"></p>

  <div class="section">
    <h3>Create New User</h3>
    <form id="createUserForm">
      <div>
        <label>Username:</label>
        <input type="text" id="newUserUsername" required />
      </div>
      <div>
        <label>Password:</label>
        <input type="password" id="newUserPassword" required />
      </div>
      <button type="submit">Create User</button>
    </form>
    <div id="createUserMsg"></div>
  </div>

  <div class="section">
    <h3>Change Admin Credentials</h3>
    <form id="changeCredentialsForm">
      <div>
        <label>Current Password:</label>
        <input type="password" id="currentPassword" required />
      </div>
      <div>
        <label>New Username:</label>
        <input type="text" id="newUsername" />
      </div>
      <div>
        <label>New Password:</label>
        <input type="password" id="newPassword" />
      </div>
      <button type="submit">Update Credentials</button>
    </form>
    <div id="credentialsMsg"></div>
  </div>

  <div class="section">
    <h3>Pending Forgot Requests</h3>
    <button id="refresh">Refresh Requests</button>
    <div id="requests"></div>
  </div>

  <div class="section">
    <h3>Reset User Password</h3>
    <form id="resetForm">
      <div>
        <label>User ID:</label>
        <input type="number" id="uid" required />
      </div>
      <div>
        <label>New Password:</label>
        <input type="text" id="npass" required />
      </div>
      <div>
        <label>Note:</label>
        <input type="text" id="note" />
      </div>
      <button type="submit">Reset Password</button>
    </form>
    <div id="resetMsg"></div>
  </div>

  <div class="section">
    <h3>All Users</h3>
    <button id="loadUsers">Load Users</button>
    <div id="usersList"></div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const token = localStorage.getItem('token');
    
    if (!user || !user.is_admin) {
      window.location = '/';
    } else {
      document.getElementById('who').innerText = 'Logged in as: ' + user.username + ' (Admin)';
    }

    // Create New User
    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('newUserUsername').value;
      const password = document.getElementById('newUserPassword').value;

      const res = await fetch('/api/admin/create_user', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify({
          username: username,
          password: password
        })
      });
      
      const data = await res.json();
      if (res.ok) {
        showMessage('createUserMsg', data.message + ' - User can now login with: ' + username + ' / ' + password, 'success');
        document.getElementById('createUserForm').reset();
        loadUsers(); // Refresh users list
      } else {
        showMessage('createUserMsg', data.error, 'error');
      }
    });

    // Change Admin Credentials
    document.getElementById('changeCredentialsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const currentPassword = document.getElementById('currentPassword').value;
      const newUsername = document.getElementById('newUsername').value;
      const newPassword = document.getElementById('newPassword').value;

      if (!newUsername && !newPassword) {
        showMessage('credentialsMsg', 'Please enter either new username or new password', 'error');
        return;
      }

      const res = await fetch('/api/admin/change_credentials', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify({
          current_password: currentPassword,
          new_username: newUsername,
          new_password: newPassword
        })
      });
      
      const data = await res.json();
      if (res.ok) {
        showMessage('credentialsMsg', data.message, 'success');
        // Update local storage if username changed
        if (newUsername) {
          const updatedUser = { ...user, username: newUsername };
          localStorage.setItem('user', JSON.stringify(updatedUser));
          document.getElementById('who').innerText = 'Logged in as: ' + newUsername + ' (Admin)';
        }
        // Clear form
        document.getElementById('changeCredentialsForm').reset();
      } else {
        showMessage('credentialsMsg', data.error, 'error');
      }
    });

    // Load Forgot Requests
    async function loadRequests() {
      const res = await fetch('/api/admin/forgot_requests', { 
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      
      const div = document.getElementById('requests');
      if (!res.ok) {
        div.innerHTML = `<div class="error">${data.error || JSON.stringify(data)}</div>`;
        return;
      }
      
      div.innerHTML = '';
      if (data.requests.length === 0) {
        div.innerHTML = '<p>No pending requests</p>';
        return;
      }
      
      data.requests.forEach(r => {
        const el = document.createElement('div');
        el.className = 'user-item';
        el.innerHTML = `
          <strong>User:</strong> ${r.username} (ID: ${r.user_id}) | 
          <strong>When:</strong> ${new Date(r.requested_at).toLocaleString()} | 
          <strong>Status:</strong> ${r.status}<br/>
          <em>Note:</em> ${r.admin_note || 'No note'}
        `;
        div.appendChild(el);
      });
    }

    document.getElementById('refresh').addEventListener('click', loadRequests);

    // Reset User Password
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const res = await fetch('/api/admin/reset_user_password', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'Authorization': 'Bearer ' + token 
        },
        body: JSON.stringify({
          user_id: Number(document.getElementById('uid').value),
          new_password: document.getElementById('npass').value,
          admin_note: document.getElementById('note').value
        })
      });
      const data = await res.json();
      
      if (res.ok) {
        showMessage('resetMsg', data.message, 'success');
        document.getElementById('resetForm').reset();
        loadRequests(); // Refresh requests
        loadUsers(); // Refresh users list
      } else {
        showMessage('resetMsg', data.error, 'error');
      }
    });

    // Load Users List
    async function loadUsers() {
      const res = await fetch('/api/users', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const data = await res.json();
      
      const div = document.getElementById('usersList');
      if (!res.ok) {
        div.innerHTML = `<div class="error">${data.error}</div>`;
        return;
      }
      
      div.innerHTML = '';
      if (data.users.length === 0) {
        div.innerHTML = '<p>No users found</p>';
        return;
      }
      
      data.users.forEach(u => {
        const el = document.createElement('div');
        el.className = u.is_admin ? 'user-item admin-user' : 'user-item';
        el.innerHTML = `
          <strong>ID:</strong> ${u.slno} | 
          <strong>Username:</strong> ${u.username} | 
          <strong>Admin:</strong> ${u.is_admin ? 'Yes' : 'No'} | 
          <strong>Created:</strong> ${new Date(u.created_at).toLocaleDateString()}<br/>
          <strong>Last Login:</strong> ${u.last_login_time ? new Date(u.last_login_time).toLocaleString() : 'Never'} |
          <strong>Forgot Request:</strong> ${u.forgot_request_status || 'None'}
        `;
        div.appendChild(el);
      });
    }

    document.getElementById('loadUsers').addEventListener('click', loadUsers);

    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = message;
      element.className = `message ${type}`;
      element.style.display = 'block';
    }

    // Load requests and users on page load
    loadRequests();
    loadUsers();
  </script>
</body>
</html>